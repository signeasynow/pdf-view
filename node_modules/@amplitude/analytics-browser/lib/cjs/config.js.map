{"version":3,"file":"config.js","sourceRoot":"","sources":["../../src/config.ts"],"names":[],"mappings":"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","sourcesContent":["import {\n  Event,\n  BrowserOptions,\n  BrowserConfig as IBrowserConfig,\n  DefaultTrackingOptions,\n  Storage,\n  TrackingOptions,\n  TransportType,\n  UserSession,\n  Logger as ILogger,\n  LogLevel,\n  Plan,\n  IngestionMetadata,\n  IdentityStorageType,\n  ServerZoneType,\n} from '@amplitude/analytics-types';\nimport { Config, Logger, MemoryStorage, UUID } from '@amplitude/analytics-core';\nimport { CookieStorage, getCookieName, FetchTransport, getQueryParams } from '@amplitude/analytics-client-common';\n\nimport { LocalStorage } from './storage/local-storage';\nimport { SessionStorage } from './storage/session-storage';\nimport { XHRTransport } from './transports/xhr';\nimport { SendBeaconTransport } from './transports/send-beacon';\nimport { parseLegacyCookies } from './cookie-migration';\nimport { CookieOptions } from '@amplitude/analytics-types/lib/esm/config/browser';\nimport { DEFAULT_IDENTITY_STORAGE, DEFAULT_SERVER_ZONE } from './constants';\nimport { AmplitudeBrowser } from './browser-client';\n\n// Exported for testing purposes only. Do not expose to public interface.\nexport class BrowserConfig extends Config implements IBrowserConfig {\n  protected _cookieStorage: Storage<UserSession>;\n  protected _deviceId?: string;\n  protected _lastEventId?: number;\n  protected _lastEventTime?: number;\n  protected _optOut = false;\n  protected _sessionId?: number;\n  protected _userId?: string;\n\n  constructor(\n    public apiKey: string,\n    public appVersion?: string,\n    cookieStorage: Storage<UserSession> = new MemoryStorage(),\n    public cookieOptions: CookieOptions = {\n      domain: '',\n      expiration: 365,\n      sameSite: 'Lax' as const,\n      secure: false,\n      upgrade: true,\n    },\n    public defaultTracking?: boolean | DefaultTrackingOptions,\n    deviceId?: string,\n    public flushIntervalMillis: number = 1000,\n    public flushMaxRetries: number = 5,\n    public flushQueueSize: number = 30,\n    public identityStorage: IdentityStorageType = DEFAULT_IDENTITY_STORAGE,\n    public ingestionMetadata?: IngestionMetadata,\n    public instanceName?: string,\n    lastEventId?: number,\n    lastEventTime?: number,\n    public loggerProvider: ILogger = new Logger(),\n    public logLevel: LogLevel = LogLevel.Warn,\n    public minIdLength?: number,\n    optOut = false,\n    public partnerId?: string,\n    public plan?: Plan,\n    public serverUrl: string = '',\n    public serverZone: ServerZoneType = DEFAULT_SERVER_ZONE,\n    sessionId?: number,\n    public sessionTimeout: number = 30 * 60 * 1000,\n    public storageProvider: Storage<Event[]> = new LocalStorage({ loggerProvider }),\n    public trackingOptions: Required<TrackingOptions> = {\n      ipAddress: true,\n      language: true,\n      platform: true,\n    },\n    public transport: 'fetch' | 'xhr' | 'beacon' = 'fetch',\n    public useBatch: boolean = false,\n    userId?: string,\n  ) {\n    super({ apiKey, storageProvider, transportProvider: createTransport(transport) });\n    this._cookieStorage = cookieStorage;\n    this.deviceId = deviceId;\n    this.lastEventId = lastEventId;\n    this.lastEventTime = lastEventTime;\n    this.optOut = optOut;\n    this.sessionId = sessionId;\n    this.userId = userId;\n    this.loggerProvider.enable(this.logLevel);\n  }\n\n  get cookieStorage() {\n    return this._cookieStorage;\n  }\n\n  set cookieStorage(cookieStorage: Storage<UserSession>) {\n    if (this._cookieStorage !== cookieStorage) {\n      this._cookieStorage = cookieStorage;\n      this.updateStorage();\n    }\n  }\n\n  get deviceId() {\n    return this._deviceId;\n  }\n\n  set deviceId(deviceId: string | undefined) {\n    if (this._deviceId !== deviceId) {\n      this._deviceId = deviceId;\n      this.updateStorage();\n    }\n  }\n\n  get userId() {\n    return this._userId;\n  }\n\n  set userId(userId: string | undefined) {\n    if (this._userId !== userId) {\n      this._userId = userId;\n      this.updateStorage();\n    }\n  }\n\n  get sessionId() {\n    return this._sessionId;\n  }\n\n  set sessionId(sessionId: number | undefined) {\n    if (this._sessionId !== sessionId) {\n      this._sessionId = sessionId;\n      this.updateStorage();\n    }\n  }\n\n  get optOut() {\n    return this._optOut;\n  }\n\n  set optOut(optOut: boolean) {\n    if (this._optOut !== optOut) {\n      this._optOut = optOut;\n      this.updateStorage();\n    }\n  }\n\n  get lastEventTime() {\n    return this._lastEventTime;\n  }\n\n  set lastEventTime(lastEventTime: number | undefined) {\n    if (this._lastEventTime !== lastEventTime) {\n      this._lastEventTime = lastEventTime;\n      this.updateStorage();\n    }\n  }\n\n  get lastEventId() {\n    return this._lastEventId;\n  }\n\n  set lastEventId(lastEventId: number | undefined) {\n    if (this._lastEventId !== lastEventId) {\n      this._lastEventId = lastEventId;\n      this.updateStorage();\n    }\n  }\n\n  private updateStorage() {\n    const cache = {\n      deviceId: this._deviceId,\n      userId: this._userId,\n      sessionId: this._sessionId,\n      optOut: this._optOut,\n      lastEventTime: this._lastEventTime,\n      lastEventId: this._lastEventId,\n    };\n    void this.cookieStorage.set(getCookieName(this.apiKey), cache);\n  }\n}\n\nexport const useBrowserConfig = async (\n  apiKey: string,\n  options: BrowserOptions = {},\n  amplitudeInstance: AmplitudeBrowser,\n): Promise<IBrowserConfig> => {\n  // Step 1: Create identity storage instance\n  const identityStorage = options.identityStorage || DEFAULT_IDENTITY_STORAGE;\n  const cookieOptions = {\n    domain:\n      identityStorage !== DEFAULT_IDENTITY_STORAGE ? '' : options.cookieOptions?.domain ?? (await getTopLevelDomain()),\n    expiration: 365,\n    sameSite: 'Lax' as const,\n    secure: false,\n    upgrade: true,\n    ...options.cookieOptions,\n  };\n  const cookieStorage = createCookieStorage<UserSession>(options.identityStorage, cookieOptions);\n\n  // Step 1: Parse cookies using identity storage instance\n  const legacyCookies = await parseLegacyCookies(apiKey, cookieStorage, options.cookieOptions?.upgrade ?? true);\n  const previousCookies = await cookieStorage.get(getCookieName(apiKey));\n  const queryParams = getQueryParams();\n\n  // Step 3: Reconcile user identity\n  const deviceId =\n    options.deviceId ?? queryParams.deviceId ?? previousCookies?.deviceId ?? legacyCookies.deviceId ?? UUID();\n  const lastEventId = previousCookies?.lastEventId ?? legacyCookies.lastEventId;\n  const lastEventTime = previousCookies?.lastEventTime ?? legacyCookies.lastEventTime;\n  const optOut = options.optOut ?? previousCookies?.optOut ?? legacyCookies.optOut;\n  const sessionId = previousCookies?.sessionId ?? legacyCookies.sessionId;\n  const userId = options.userId ?? previousCookies?.userId ?? legacyCookies.userId;\n  amplitudeInstance.previousSessionDeviceId = previousCookies?.deviceId ?? legacyCookies.deviceId;\n  amplitudeInstance.previousSessionUserId = previousCookies?.userId ?? legacyCookies.userId;\n\n  const trackingOptions = {\n    ipAddress: options.trackingOptions?.ipAddress ?? true,\n    language: options.trackingOptions?.language ?? true,\n    platform: options.trackingOptions?.platform ?? true,\n  };\n\n  return new BrowserConfig(\n    apiKey,\n    options.appVersion,\n    cookieStorage,\n    cookieOptions,\n    options.defaultTracking,\n    deviceId,\n    options.flushIntervalMillis,\n    options.flushMaxRetries,\n    options.flushQueueSize,\n    identityStorage,\n    options.ingestionMetadata,\n    options.instanceName,\n    lastEventId,\n    lastEventTime,\n    options.loggerProvider,\n    options.logLevel,\n    options.minIdLength,\n    optOut,\n    options.partnerId,\n    options.plan,\n    options.serverUrl,\n    options.serverZone,\n    sessionId,\n    options.sessionTimeout,\n    options.storageProvider,\n    trackingOptions,\n    options.transport,\n    options.useBatch,\n    userId,\n  );\n};\n\nexport const createCookieStorage = <T>(\n  identityStorage: IdentityStorageType = DEFAULT_IDENTITY_STORAGE,\n  cookieOptions: CookieOptions = {},\n) => {\n  switch (identityStorage) {\n    case 'localStorage':\n      return new LocalStorage<T>();\n    case 'sessionStorage':\n      return new SessionStorage<T>();\n    case 'none':\n      return new MemoryStorage<T>();\n    case 'cookie':\n    default:\n      return new CookieStorage<T>({\n        ...cookieOptions,\n        expirationDays: cookieOptions.expiration,\n      });\n  }\n};\n\nexport const createTransport = (transport?: TransportType) => {\n  if (transport === 'xhr') {\n    return new XHRTransport();\n  }\n  if (transport === 'beacon') {\n    return new SendBeaconTransport();\n  }\n  return new FetchTransport();\n};\n\nexport const getTopLevelDomain = async (url?: string) => {\n  if (!(await new CookieStorage<number>().isEnabled()) || (!url && typeof location === 'undefined')) {\n    return '';\n  }\n\n  const host = url ?? location.hostname;\n  const parts = host.split('.');\n  const levels = [];\n  const storageKey = 'AMP_TLDTEST';\n\n  for (let i = parts.length - 2; i >= 0; --i) {\n    levels.push(parts.slice(i).join('.'));\n  }\n  for (let i = 0; i < levels.length; i++) {\n    const domain = levels[i];\n    const options = { domain: '.' + domain };\n    const storage = new CookieStorage<number>(options);\n    await storage.set(storageKey, 1);\n    const value = await storage.get(storageKey);\n    if (value) {\n      await storage.remove(storageKey);\n      return '.' + domain;\n    }\n  }\n\n  return '';\n};\n"]}